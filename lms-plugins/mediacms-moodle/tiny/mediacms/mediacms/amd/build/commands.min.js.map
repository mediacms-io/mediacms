{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media commands.\n *\n * @module      tiny_mediacms/commands\n * @copyright   2022 Huong Nguyen <huongnv13@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getStrings} from 'core/str';\nimport {\n    component,\n    iframeButtonName,\n    iframeMenuItemName,\n    iframeIcon,\n} from './common';\nimport IframeEmbed from './iframeembed';\nimport {getButtonImage} from 'editor_tiny/utils';\n\nconst isIframe = (node) => node.nodeName.toLowerCase() === 'iframe' ||\n    (node.classList && node.classList.contains('tiny-iframe-responsive')) ||\n    (node.classList && node.classList.contains('tiny-mediacms-iframe-wrapper'));\n\n/**\n * Wrap iframes with overlay containers that allow hover detection.\n * Since iframes capture mouse events, we add an invisible overlay on top\n * that shows the edit button on hover.\n *\n * @param {TinyMCE} editor - The editor instance\n * @param {Function} handleIframeAction - The action to perform when clicking the button\n */\nconst setupIframeOverlays = (editor, handleIframeAction) => {\n    /**\n     * Process all iframes in the editor and add overlay wrappers.\n     */\n    const processIframes = () => {\n        const editorBody = editor.getBody();\n        if (!editorBody) {\n            return;\n        }\n\n        const iframes = editorBody.querySelectorAll('iframe');\n        iframes.forEach((iframe) => {\n            // Skip if already wrapped\n            if (iframe.parentElement?.classList.contains('tiny-mediacms-iframe-wrapper')) {\n                return;\n            }\n\n            // Skip TinyMCE internal iframes\n            if (iframe.hasAttribute('data-mce-object') || iframe.hasAttribute('data-mce-placeholder')) {\n                return;\n            }\n\n            // Create wrapper div\n            const wrapper = editor.getDoc().createElement('div');\n            wrapper.className = 'tiny-mediacms-iframe-wrapper';\n            wrapper.setAttribute('contenteditable', 'false');\n\n            // Create edit button (positioned inside wrapper, over the iframe)\n            const editBtn = editor.getDoc().createElement('button');\n            editBtn.className = 'tiny-mediacms-edit-btn';\n            editBtn.setAttribute('type', 'button');\n            editBtn.setAttribute('title', 'Edit video embed options');\n            // Use clean inline SVG to avoid TinyMCE wrapper issues\n            editBtn.innerHTML = '<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\">' +\n                '<circle cx=\"50\" cy=\"50\" r=\"48\" fill=\"#2EAF5A\"/>' +\n                '<polygon points=\"38,28 38,72 75,50\" fill=\"#FFFFFF\"/>' +\n                '</svg>';\n\n            // Wrap the iframe: insert wrapper, move iframe into it, add button\n            iframe.parentNode.insertBefore(wrapper, iframe);\n            wrapper.appendChild(iframe);\n            wrapper.appendChild(editBtn);\n        });\n    };\n\n    /**\n     * Add CSS styles for hover effects to the editor's document.\n     */\n    const addStyles = () => {\n        const editorDoc = editor.getDoc();\n        if (!editorDoc) {\n            return;\n        }\n\n        // Check if styles already added\n        if (editorDoc.getElementById('tiny-mediacms-overlay-styles')) {\n            return;\n        }\n\n        const style = editorDoc.createElement('style');\n        style.id = 'tiny-mediacms-overlay-styles';\n        style.textContent = `\n            .tiny-mediacms-iframe-wrapper {\n                display: inline-block;\n                position: relative;\n                line-height: 0;\n                vertical-align: top;\n            }\n            .tiny-mediacms-iframe-wrapper iframe {\n                display: block;\n            }\n            .tiny-mediacms-edit-btn {\n                position: absolute;\n                top: 48px;\n                left: 6px;\n                width: 28px;\n                height: 28px;\n                background: #ffffff;\n                border: none;\n                border-radius: 50%;\n                cursor: pointer;\n                z-index: 10;\n                padding: 0;\n                margin: 0;\n                box-shadow: 0 2px 6px rgba(0,0,0,0.35);\n                transition: transform 0.15s, box-shadow 0.15s;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-sizing: border-box;\n            }\n            .tiny-mediacms-edit-btn:hover {\n                transform: scale(1.15);\n                box-shadow: 0 3px 10px rgba(0,0,0,0.45);\n            }\n            .tiny-mediacms-edit-btn svg {\n                width: 18px !important;\n                height: 18px !important;\n                display: block !important;\n            }\n        `;\n        editorDoc.head.appendChild(style);\n    };\n\n    /**\n     * Handle click on the edit button.\n     *\n     * @param {Event} e - The click event\n     */\n    const handleOverlayClick = (e) => {\n        const target = e.target;\n\n        // Check if clicked on edit button or its child (svg/path)\n        const editBtn = target.closest('.tiny-mediacms-edit-btn');\n        if (!editBtn) {\n            return;\n        }\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        // Find the associated wrapper and iframe\n        const wrapper = editBtn.closest('.tiny-mediacms-iframe-wrapper');\n        if (!wrapper) {\n            return;\n        }\n\n        const iframe = wrapper.querySelector('iframe');\n        if (!iframe) {\n            return;\n        }\n\n        // Select the wrapper so TinyMCE knows which element is selected\n        editor.selection.select(wrapper);\n\n        // Open the edit dialog\n        handleIframeAction();\n    };\n\n    // Setup on editor init\n    editor.on('init', () => {\n        addStyles();\n        processIframes();\n\n        // Handle clicks on the overlay\n        editor.getBody().addEventListener('click', handleOverlayClick);\n    });\n\n    // Re-process when content changes\n    editor.on('SetContent', () => {\n        processIframes();\n    });\n\n    // Re-process when content is pasted\n    editor.on('PastePostProcess', () => {\n        setTimeout(processIframes, 100);\n    });\n\n    // Re-process after undo/redo\n    editor.on('Undo Redo', () => {\n        processIframes();\n    });\n\n    // Re-process on any content change (covers modal updates)\n    editor.on('Change', () => {\n        setTimeout(processIframes, 50);\n    });\n\n    // Re-process when node changes (selection changes)\n    editor.on('NodeChange', () => {\n        processIframes();\n    });\n};\n\nconst registerIframeCommand = (editor, iframeButtonText, iframeButtonImage) => {\n    const handleIframeAction = () => {\n        const iframeEmbed = new IframeEmbed(editor);\n        iframeEmbed.displayDialogue();\n    };\n\n    // Register the iframe icon\n    editor.ui.registry.addIcon(iframeIcon, iframeButtonImage.html);\n\n    // Register the Menu Button as a toggle.\n    // This means that when highlighted over an existing iframe element it will show as toggled on.\n    editor.ui.registry.addToggleButton(iframeButtonName, {\n        icon: iframeIcon,\n        tooltip: iframeButtonText,\n        onAction: handleIframeAction,\n        onSetup: api => {\n            return editor.selection.selectorChangedWithUnbind(\n                'iframe:not([data-mce-object]):not([data-mce-placeholder]),.tiny-iframe-responsive,.tiny-mediacms-iframe-wrapper',\n                api.setActive\n            ).unbind;\n        }\n    });\n\n    editor.ui.registry.addMenuItem(iframeMenuItemName, {\n        icon: iframeIcon,\n        text: iframeButtonText,\n        onAction: handleIframeAction,\n    });\n\n    editor.ui.registry.addContextToolbar(iframeButtonName, {\n        predicate: isIframe,\n        items: iframeButtonName,\n        position: 'node',\n        scope: 'node'\n    });\n\n    editor.ui.registry.addContextMenu(iframeButtonName, {\n        update: isIframe,\n    });\n\n    // Setup iframe overlays with edit button on hover\n    setupIframeOverlays(editor, handleIframeAction);\n};\n\nexport const getSetup = async() => {\n    const [\n        iframeButtonText,\n    ] = await getStrings([\n        'iframebuttontitle',\n    ].map((key) => ({key, component})));\n\n    const [\n        iframeButtonImage,\n    ] = await Promise.all([\n        getButtonImage('icon', component),\n    ]);\n\n    // Note: The function returned here must be synchronous and cannot use promises.\n    // All promises must be resolved prior to returning the function.\n    return (editor) => {\n        registerIframeCommand(editor, iframeButtonText, iframeButtonImage);\n    };\n};\n"],"names":["isIframe","node","nodeName","toLowerCase","classList","contains","setupIframeOverlays","editor","handleIframeAction","processIframes","editorBody","getBody","querySelectorAll","forEach","iframe","parentElement","_iframe$parentElement","hasAttribute","wrapper","getDoc","createElement","className","setAttribute","editBtn","innerHTML","parentNode","insertBefore","appendChild","handleOverlayClick","e","target","closest","preventDefault","stopPropagation","querySelector","selection","select","on","editorDoc","getElementById","style","id","textContent","head","addStyles","addEventListener","setTimeout","async","iframeButtonText","map","key","component","iframeButtonImage","Promise","all","IframeEmbed","displayDialogue","ui","registry","addIcon","iframeIcon","html","addToggleButton","iframeButtonName","icon","tooltip","onAction","onSetup","api","selectorChangedWithUnbind","setActive","unbind","addMenuItem","iframeMenuItemName","text","addContextToolbar","predicate","items","position","scope","addContextMenu","update","registerIframeCommand"],"mappings":";;;;;;;8JAiCMA,SAAYC,MAAyC,WAAhCA,KAAKC,SAASC,eACpCF,KAAKG,WAAaH,KAAKG,UAAUC,SAAS,2BAC1CJ,KAAKG,WAAaH,KAAKG,UAAUC,SAAS,gCAUzCC,oBAAsB,CAACC,OAAQC,4BAI3BC,eAAiB,WACbC,WAAaH,OAAOI,cACrBD,kBAIWA,WAAWE,iBAAiB,UACpCC,SAASC,oEAETA,OAAOC,gDAAPC,sBAAsBZ,UAAUC,SAAS,0CAKzCS,OAAOG,aAAa,oBAAsBH,OAAOG,aAAa,qCAK5DC,QAAUX,OAAOY,SAASC,cAAc,OAC9CF,QAAQG,UAAY,+BACpBH,QAAQI,aAAa,kBAAmB,eAGlCC,QAAUhB,OAAOY,SAASC,cAAc,UAC9CG,QAAQF,UAAY,yBACpBE,QAAQD,aAAa,OAAQ,UAC7BC,QAAQD,aAAa,QAAS,4BAE9BC,QAAQC,UAAY,0KAMpBV,OAAOW,WAAWC,aAAaR,QAASJ,QACxCI,QAAQS,YAAYb,QACpBI,QAAQS,YAAYJ,aAoEtBK,mBAAsBC,UAIlBN,QAHSM,EAAEC,OAGMC,QAAQ,+BAC1BR,eAILM,EAAEG,iBACFH,EAAEI,wBAGIf,QAAUK,QAAQQ,QAAQ,qCAC3Bb,eAIUA,QAAQgB,cAAc,YAMrC3B,OAAO4B,UAAUC,OAAOlB,SAGxBV,uBAIJD,OAAO8B,GAAG,QAAQ,KA5FA,YACRC,UAAY/B,OAAOY,aACpBmB,oBAKDA,UAAUC,eAAe,6CAIvBC,MAAQF,UAAUlB,cAAc,SACtCoB,MAAMC,GAAK,+BACXD,MAAME,02CAwCNJ,UAAUK,KAAKhB,YAAYa,QAwC3BI,GACAnC,iBAGAF,OAAOI,UAAUkC,iBAAiB,QAASjB,uBAI/CrB,OAAO8B,GAAG,cAAc,KACpB5B,oBAIJF,OAAO8B,GAAG,oBAAoB,KAC1BS,WAAWrC,eAAgB,QAI/BF,OAAO8B,GAAG,aAAa,KACnB5B,oBAIJF,OAAO8B,GAAG,UAAU,KAChBS,WAAWrC,eAAgB,OAI/BF,OAAO8B,GAAG,cAAc,KACpB5B,uCAgDgBsC,gBAEhBC,wBACM,mBAAW,CACjB,qBACFC,KAAKC,OAAUA,IAAAA,IAAKC,UAAAA,wBAGlBC,yBACMC,QAAQC,IAAI,EAClB,yBAAe,OAAQH,4BAKnB5C,SA3DkB,EAACA,OAAQyC,iBAAkBI,2BAC/C5C,mBAAqB,KACH,IAAI+C,qBAAYhD,QACxBiD,mBAIhBjD,OAAOkD,GAAGC,SAASC,QAAQC,mBAAYR,kBAAkBS,MAIzDtD,OAAOkD,GAAGC,SAASI,gBAAgBC,yBAAkB,CACjDC,KAAMJ,mBACNK,QAASjB,iBACTkB,SAAU1D,mBACV2D,QAASC,KACE7D,OAAO4B,UAAUkC,0BACpB,kHACAD,IAAIE,WACNC,SAIVhE,OAAOkD,GAAGC,SAASc,YAAYC,2BAAoB,CAC/CT,KAAMJ,mBACNc,KAAM1B,iBACNkB,SAAU1D,qBAGdD,OAAOkD,GAAGC,SAASiB,kBAAkBZ,yBAAkB,CACnDa,UAAW5E,SACX6E,MAAOd,yBACPe,SAAU,OACVC,MAAO,SAGXxE,OAAOkD,GAAGC,SAASsB,eAAejB,yBAAkB,CAChDkB,OAAQjF,WAIZM,oBAAoBC,OAAQC,qBAmBxB0E,CAAsB3E,OAAQyC,iBAAkBI"}