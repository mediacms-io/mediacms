{"version":3,"file":"iframeembed.min.js","sources":["../src/iframeembed.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media2 Iframe Embed class.\n *\n * @module      tiny_mediacms/iframeembed\n * @copyright   2024\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport { getString } from 'core/str';\nimport * as ModalEvents from 'core/modal_events';\nimport { component } from './common';\nimport IframeModal from './iframemodal';\nimport Selectors from './selectors';\nimport { getLti, getData } from './options';\n\nexport default class IframeEmbed {\n    editor = null;\n    currentModal = null;\n    isUpdating = false;\n    selectedIframe = null;\n    debounceTimer = null;\n    // Iframe library state\n    iframeLibraryLoaded = false;\n    selectedLibraryVideo = null;\n    iframeLibraryUrl =\n        'https://temp.web357.com/mediacms/deic-mediacms-embed-videos.html';\n\n    constructor(editor) {\n        this.editor = editor;\n    }\n\n    /**\n     * Parse input to extract video URL or iframe src.\n     * Handles: iframe embed code, view URL, or embed URL.\n     *\n     * @param {string} input - The user input (URL or embed code)\n     * @returns {Object|null} Parsed URL info or null if invalid\n     */\n    parseInput(input) {\n        if (!input || !input.trim()) {\n            return null;\n        }\n\n        input = input.trim();\n\n        // Check if it's an iframe embed code\n        const iframeMatch = input.match(\n            /<iframe[^>]*src=[\"']([^\"']+)[\"'][^>]*>/i,\n        );\n        if (iframeMatch) {\n            return this.parseEmbedUrl(iframeMatch[1]);\n        }\n\n        // Check if it's a URL\n        if (input.startsWith('http://') || input.startsWith('https://')) {\n            return this.parseVideoUrl(input);\n        }\n\n        return null;\n    }\n\n    /**\n     * Parse a video view URL and convert to embed format.\n     *\n     * @param {string} url - The video URL\n     * @returns {Object|null} Parsed info\n     */\n    parseVideoUrl(url) {\n        try {\n            const urlObj = new URL(url);\n            const baseUrl = `${urlObj.protocol}//${urlObj.host}`;\n\n            // MediaCMS view URL: /view?m=VIDEO_ID\n            if (urlObj.pathname === '/view' && urlObj.searchParams.has('m')) {\n                return {\n                    baseUrl: baseUrl,\n                    videoId: urlObj.searchParams.get('m'),\n                    isEmbed: false,\n                };\n            }\n\n            // MediaCMS embed URL: /embed?m=VIDEO_ID&options\n            if (urlObj.pathname === '/embed' && urlObj.searchParams.has('m')) {\n                const tParam = urlObj.searchParams.get('t');\n                return {\n                    baseUrl: baseUrl,\n                    videoId: urlObj.searchParams.get('m'),\n                    isEmbed: true,\n                    showTitle: urlObj.searchParams.get('showTitle') === '1',\n                    linkTitle: urlObj.searchParams.get('linkTitle') === '1',\n                    showRelated: urlObj.searchParams.get('showRelated') === '1',\n                    showUserAvatar:\n                        urlObj.searchParams.get('showUserAvatar') === '1',\n                    startAt: tParam\n                        ? this.secondsToTimeString(parseInt(tParam))\n                        : null,\n                };\n            }\n\n            // Generic URL - just use as-is\n            return {\n                baseUrl: baseUrl,\n                rawUrl: url,\n                isGeneric: true,\n            };\n        } catch (e) {\n            return null;\n        }\n    }\n\n    /**\n     * Parse an embed URL.\n     *\n     * @param {string} url - The embed URL\n     * @returns {Object|null} Parsed info\n     */\n    parseEmbedUrl(url) {\n        return this.parseVideoUrl(url);\n    }\n\n    /**\n     * Convert seconds to time string (M:SS format).\n     *\n     * @param {number} seconds - Time in seconds\n     * @returns {string} Time string\n     */\n    secondsToTimeString(seconds) {\n        const mins = Math.floor(seconds / 60);\n        const secs = seconds % 60;\n        return `${mins}:${secs.toString().padStart(2, '0')}`;\n    }\n\n    /**\n     * Convert time string to seconds.\n     *\n     * @param {string} timeStr - Time string (M:SS or just seconds)\n     * @returns {number|null} Seconds or null if invalid\n     */\n    timeStringToSeconds(timeStr) {\n        if (!timeStr || !timeStr.trim()) {\n            return null;\n        }\n        timeStr = timeStr.trim();\n\n        // Handle M:SS format\n        if (timeStr.includes(':')) {\n            const parts = timeStr.split(':');\n            const mins = parseInt(parts[0]) || 0;\n            const secs = parseInt(parts[1]) || 0;\n            return mins * 60 + secs;\n        }\n\n        // Handle plain seconds\n        const secs = parseInt(timeStr);\n        return isNaN(secs) ? null : secs;\n    }\n\n    /**\n     * Build the embed URL with options.\n     *\n     * @param {Object} parsed - Parsed URL info\n     * @param {Object} options - Embed options\n     * @returns {string} The complete embed URL\n     */\n    buildEmbedUrl(parsed, options) {\n        if (parsed.isGeneric) {\n            return parsed.rawUrl;\n        }\n\n        const url = new URL(`${parsed.baseUrl}/embed`);\n        url.searchParams.set('m', parsed.videoId);\n\n        // Always include all options with 1 or 0\n        url.searchParams.set('showTitle', options.showTitle ? '1' : '0');\n        url.searchParams.set('showRelated', options.showRelated ? '1' : '0');\n        url.searchParams.set(\n            'showUserAvatar',\n            options.showUserAvatar ? '1' : '0',\n        );\n        url.searchParams.set('linkTitle', options.linkTitle ? '1' : '0');\n\n        // Add start time if enabled\n        if (options.startAtEnabled && options.startAt) {\n            const seconds = this.timeStringToSeconds(options.startAt);\n            if (seconds !== null && seconds > 0) {\n                url.searchParams.set('t', seconds.toString());\n            }\n        }\n\n        return url.toString();\n    }\n\n    /**\n     * Get the template context for the modal.\n     *\n     * @param {Object} data - Existing data for updating\n     * @returns {Object} Template context\n     */\n    async getTemplateContext(data = {}) {\n        // Get admin settings for default checkbox values.\n        const editorData = getData(this.editor);\n        const autoConvertOptions = editorData?.autoConvertOptions || {};\n\n        // Use admin settings as defaults when creating new embed (not updating).\n        // When updating, use the values from the existing iframe.\n        const getDefault = (key, fallback = true) => {\n            if (this.isUpdating && data[key] !== undefined) {\n                return data[key];\n            }\n            return autoConvertOptions[key] !== undefined\n                ? autoConvertOptions[key]\n                : fallback;\n        };\n\n        return {\n            elementid: this.editor.getElement().id,\n            isupdating: this.isUpdating,\n            url: data.url || '',\n            showTitle: getDefault('showTitle'),\n            linkTitle: getDefault('linkTitle'),\n            showRelated: getDefault('showRelated'),\n            showUserAvatar: getDefault('showUserAvatar'),\n            responsive: data.responsive !== false,\n            startAtEnabled: data.startAtEnabled || false,\n            startAt: data.startAt || '0:00',\n            width: data.width || 560,\n            height: data.height || 315,\n            is16_9: !data.aspectRatio || data.aspectRatio === '16:9',\n            is4_3: data.aspectRatio === '4:3',\n            is1_1: data.aspectRatio === '1:1',\n            isCustom: data.aspectRatio === 'custom',\n        };\n    }\n\n    /**\n     * Display the iframe embed dialog.\n     */\n    async displayDialogue() {\n        this.selectedIframe = this.getSelectedIframe();\n        const data = this.getCurrentIframeData();\n        this.isUpdating = data !== null;\n\n        // Reset iframe library state for new modal\n        this.iframeLibraryLoaded = false;\n\n        this.currentModal = await IframeModal.create({\n            title: getString('iframemodaltitle', component),\n            templateContext: await this.getTemplateContext(data || {}),\n        });\n\n        await this.registerEventListeners(this.currentModal);\n    }\n\n    /**\n     * Get the currently selected iframe in the editor.\n     *\n     * @returns {HTMLElement|null} The iframe element or null\n     */\n    getSelectedIframe() {\n        const node = this.editor.selection.getNode();\n\n        if (node.nodeName.toLowerCase() === 'iframe') {\n            return node;\n        }\n\n        // Check if selection contains an iframe wrapper (including overlay wrapper)\n        const iframe = node.querySelector('iframe');\n        if (iframe) {\n            return iframe;\n        }\n\n        // Check if we're on the overlay or wrapper and need to find the iframe\n        const wrapper =\n            node.closest('.tiny-mediacms-iframe-wrapper') ||\n            node.closest('.tiny-iframe-responsive');\n        if (wrapper) {\n            return wrapper.querySelector('iframe');\n        }\n\n        return null;\n    }\n\n    /**\n     * Get current iframe data for editing.\n     *\n     * @returns {Object|null} Current iframe data or null\n     */\n    getCurrentIframeData() {\n        if (!this.selectedIframe) {\n            return null;\n        }\n\n        const src = this.selectedIframe.getAttribute('src');\n        const parsed = this.parseInput(src);\n\n        // Check if responsive by looking at style\n        const style = this.selectedIframe.getAttribute('style') || '';\n        const isResponsive = style.includes('aspect-ratio');\n\n        return {\n            url: src,\n            width: this.selectedIframe.getAttribute('width') || 560,\n            height: this.selectedIframe.getAttribute('height') || 315,\n            showTitle: parsed?.showTitle ?? true,\n            linkTitle: parsed?.linkTitle ?? true,\n            showRelated: parsed?.showRelated ?? true,\n            showUserAvatar: parsed?.showUserAvatar ?? true,\n            responsive: isResponsive,\n            startAtEnabled: parsed?.startAt !== null,\n            startAt: parsed?.startAt || '0:00',\n        };\n    }\n\n    /**\n     * Get form values from the modal.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @returns {Object} Form values\n     */\n    getFormValues(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        return {\n            url: form.querySelector(Selectors.IFRAME.elements.url).value.trim(),\n            showTitle: form.querySelector(Selectors.IFRAME.elements.showTitle)\n                .checked,\n            linkTitle: form.querySelector(Selectors.IFRAME.elements.linkTitle)\n                .checked,\n            showRelated: form.querySelector(\n                Selectors.IFRAME.elements.showRelated,\n            ).checked,\n            showUserAvatar: form.querySelector(\n                Selectors.IFRAME.elements.showUserAvatar,\n            ).checked,\n            responsive: form.querySelector(Selectors.IFRAME.elements.responsive)\n                .checked,\n            startAtEnabled: form.querySelector(\n                Selectors.IFRAME.elements.startAtEnabled,\n            ).checked,\n            startAt: form\n                .querySelector(Selectors.IFRAME.elements.startAt)\n                .value.trim(),\n            aspectRatio: form.querySelector(\n                Selectors.IFRAME.elements.aspectRatio,\n            ).value,\n            width:\n                parseInt(\n                    form.querySelector(Selectors.IFRAME.elements.width).value,\n                ) || 560,\n            height:\n                parseInt(\n                    form.querySelector(Selectors.IFRAME.elements.height).value,\n                ) || 315,\n        };\n    }\n\n    /**\n     * Generate the iframe HTML.\n     *\n     * @param {Object} values - Form values\n     * @returns {Promise<string>} Generated HTML\n     */\n    async generateIframeHtml(values) {\n        const parsed = this.parseInput(values.url);\n        if (!parsed) {\n            return '';\n        }\n\n        const embedUrl = this.buildEmbedUrl(parsed, values);\n\n        // Calculate aspect ratio values for CSS\n        const aspectRatioCalcs = {\n            '16:9': '16 / 9',\n            '4:3': '4 / 3',\n            '1:1': '1 / 1',\n            custom: `${values.width} / ${values.height}`,\n        };\n\n        const context = {\n            src: embedUrl,\n            width: values.width,\n            height: values.height,\n            responsive: values.responsive,\n            aspectRatioCalc: aspectRatioCalcs[values.aspectRatio] || '16 / 9',\n            aspectRatioValue: aspectRatioCalcs[values.aspectRatio] || '16 / 9',\n        };\n\n        const { html } = await Templates.renderForPromise(\n            'tiny_mediacms/iframe_embed_output',\n            context,\n        );\n        return html;\n    }\n\n    /**\n     * Update the preview in the modal.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {boolean} updateUrlField - Whether to update the URL field with new embed options\n     */\n    async updatePreview(root, updateUrlField = false) {\n        const values = this.getFormValues(root);\n        const previewContainer = root.querySelector(\n            Selectors.IFRAME.elements.preview,\n        );\n        const urlWarning = root.querySelector(\n            Selectors.IFRAME.elements.urlWarning,\n        );\n\n        if (!values.url) {\n            previewContainer.innerHTML =\n                '<span class=\"text-muted\">Enter a video URL to see preview</span>';\n            urlWarning.classList.add('d-none');\n            return;\n        }\n\n        const parsed = this.parseInput(values.url);\n        if (!parsed) {\n            previewContainer.innerHTML =\n                '<span class=\"text-danger\">Invalid URL format</span>';\n            urlWarning.classList.remove('d-none');\n            return;\n        }\n\n        urlWarning.classList.add('d-none');\n        const embedUrl = this.buildEmbedUrl(parsed, values);\n\n        // Update the URL field if requested (when embed options change)\n        if (updateUrlField && !parsed.isGeneric) {\n            const form = root.querySelector(Selectors.IFRAME.elements.form);\n            const urlInput = form.querySelector(Selectors.IFRAME.elements.url);\n            urlInput.value = embedUrl;\n        }\n\n        // Show a scaled preview\n        const previewWidth = Math.min(values.width, 400);\n        const scale = previewWidth / values.width;\n        const previewHeight = Math.round(values.height * scale);\n\n        previewContainer.innerHTML = `\n            <iframe \n                src=\"${embedUrl}\" \n                width=\"${previewWidth}\" \n                height=\"${previewHeight}\" \n                frameborder=\"0\" \n                allowfullscreen\n                style=\"max-width: 100%;\">\n            </iframe>\n        `;\n    }\n\n    /**\n     * Handle form input changes with debounce.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {boolean} updateUrlField - Whether to update the URL field\n     */\n    handleInputChange(root, updateUrlField = false) {\n        clearTimeout(this.debounceTimer);\n        this.debounceTimer = setTimeout(() => {\n            this.updatePreview(root, updateUrlField);\n        }, 500);\n    }\n\n    /**\n     * Handle aspect ratio change - update dimensions.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleAspectRatioChange(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const aspectRatio = form.querySelector(\n            Selectors.IFRAME.elements.aspectRatio,\n        ).value;\n        const dimensions = Selectors.IFRAME.aspectRatios[aspectRatio];\n\n        // Only update dimensions for predefined ratios, not 'custom'\n        if (dimensions && aspectRatio !== 'custom') {\n            form.querySelector(Selectors.IFRAME.elements.width).value =\n                dimensions.width;\n            form.querySelector(Selectors.IFRAME.elements.height).value =\n                dimensions.height;\n        }\n\n        this.updatePreview(root);\n    }\n\n    /**\n     * Handle dialog submission.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async handleDialogueSubmission(modal) {\n        const root = modal.getRoot()[0];\n        const values = this.getFormValues(root);\n\n        if (!values.url) {\n            return;\n        }\n\n        const html = await this.generateIframeHtml(values);\n        if (html) {\n            if (this.isUpdating && this.selectedIframe) {\n                // Replace existing iframe (including wrapper if present)\n                // Check for both old wrapper and new overlay wrapper\n                const wrapper =\n                    this.selectedIframe.closest(\n                        '.tiny-mediacms-iframe-wrapper',\n                    ) || this.selectedIframe.closest('.tiny-iframe-responsive');\n                if (wrapper) {\n                    wrapper.outerHTML = html;\n                } else {\n                    this.selectedIframe.outerHTML = html;\n                }\n                this.isUpdating = false;\n                // Fire change event to trigger overlay reprocessing\n                this.editor.fire('Change');\n            } else {\n                this.editor.insertContent(html);\n            }\n        }\n    }\n\n    /**\n     * Handle video removal from the editor.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async handleRemove(modal) {\n        // Get confirmation string\n        const confirmMessage = await getString(\n            'removeiframeconfirm',\n            component,\n        );\n\n        // Show confirmation dialog\n        // eslint-disable-next-line no-alert\n        if (!window.confirm(confirmMessage)) {\n            return;\n        }\n\n        if (this.selectedIframe) {\n            // Remove the iframe (including wrapper if present)\n            const wrapper =\n                this.selectedIframe.closest('.tiny-mediacms-iframe-wrapper') ||\n                this.selectedIframe.closest('.tiny-iframe-responsive');\n            if (wrapper) {\n                wrapper.remove();\n            } else {\n                this.selectedIframe.remove();\n            }\n        }\n\n        // Close the modal\n        this.isUpdating = false;\n        modal.hide();\n    }\n\n    /**\n     * Register event listeners for the modal.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async registerEventListeners(modal) {\n        await modal.getBody();\n        const $root = modal.getRoot();\n        const root = $root[0];\n\n        // Input change handlers\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // URL input\n        form.querySelector(Selectors.IFRAME.elements.url).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n\n        // Embed option checkboxes - these should update the URL field when changed\n        [\n            Selectors.IFRAME.elements.showTitle,\n            Selectors.IFRAME.elements.linkTitle,\n            Selectors.IFRAME.elements.showRelated,\n            Selectors.IFRAME.elements.showUserAvatar,\n            Selectors.IFRAME.elements.startAtEnabled,\n        ].forEach((selector) => {\n            form.querySelector(selector).addEventListener('change', () =>\n                this.handleInputChange(root, true), // Update URL field when embed options change\n            );\n        });\n\n        // Responsive checkbox - doesn't affect URL, only display\n        form.querySelector(Selectors.IFRAME.elements.responsive).addEventListener('change', () =>\n            this.handleInputChange(root, false),\n        );\n\n        // Start at time input - should update URL field\n        form.querySelector(Selectors.IFRAME.elements.startAt).addEventListener(\n            'input',\n            () => this.handleInputChange(root, true),\n        );\n\n        // Aspect ratio change\n        form.querySelector(\n            Selectors.IFRAME.elements.aspectRatio,\n        ).addEventListener('change', () => this.handleAspectRatioChange(root));\n\n        // Dimension inputs\n        form.querySelector(Selectors.IFRAME.elements.width).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n        form.querySelector(Selectors.IFRAME.elements.height).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n\n        // Modal events\n        $root.on(ModalEvents.save, () => this.handleDialogueSubmission(modal));\n        $root.on(ModalEvents.hidden, () => {\n            this.currentModal.destroy();\n        });\n\n        // Remove button handler (only present when updating)\n        const removeBtn = root.querySelector(Selectors.IFRAME.actions.remove);\n        if (removeBtn) {\n            removeBtn.addEventListener('click', () => this.handleRemove(modal));\n        }\n\n        // Initial preview if we have a URL\n        const urlInput = form.querySelector(Selectors.IFRAME.elements.url);\n        if (urlInput.value) {\n            this.updatePreview(root);\n        }\n\n        // Tab change handler - load iframe library when switching to iframe library tab\n        const iframeLibraryTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabIframeLibraryBtn,\n        );\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n\n                // Manually handle tab switching for Bootstrap 5\n                this.switchToIframeLibraryTab(root);\n\n                // Small delay to ensure tab pane is visible before loading iframe\n                setTimeout(() => this.handleIframeLibraryTabClick(root), 100);\n            });\n            // Also handle Bootstrap tab events (if Bootstrap handles it)\n            iframeLibraryTabBtn.addEventListener('shown.bs.tab', () =>\n                this.handleIframeLibraryTabClick(root),\n            );\n            // jQuery Bootstrap 4 event\n            const $iframeLibraryTabBtn = window.jQuery\n                ? window.jQuery(iframeLibraryTabBtn)\n                : null;\n            if ($iframeLibraryTabBtn) {\n                $iframeLibraryTabBtn.on('shown.bs.tab', () =>\n                    this.handleIframeLibraryTabClick(root),\n                );\n            }\n        }\n\n        // Tab change handler for URL tab\n        const urlTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabUrlBtn,\n        );\n        if (urlTabBtn) {\n            urlTabBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n\n                // Manually handle tab switching\n                this.switchToUrlTab(root);\n            });\n        }\n\n        // Iframe library event listeners\n        this.registerIframeLibraryEventListeners(root);\n    }\n\n    /**\n     * Switch to the URL tab.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    switchToUrlTab(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Get tab buttons\n        const urlTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabUrlBtn,\n        );\n        const iframeLibraryTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabIframeLibraryBtn,\n        );\n\n        // Get tab panes\n        const urlPane = form.querySelector(Selectors.IFRAME.elements.paneUrl);\n        const iframeLibraryPane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        // Update tab button states\n        if (urlTabBtn) {\n            urlTabBtn.classList.add('active');\n            urlTabBtn.setAttribute('aria-selected', 'true');\n        }\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.classList.remove('active');\n            iframeLibraryTabBtn.setAttribute('aria-selected', 'false');\n        }\n\n        // Update tab pane visibility\n        if (urlPane) {\n            urlPane.classList.add('show', 'active');\n        }\n        if (iframeLibraryPane) {\n            iframeLibraryPane.classList.remove('show', 'active');\n        }\n    }\n\n    /**\n     * Switch to the iframe library tab.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    switchToIframeLibraryTab(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Get tab buttons\n        const urlTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabUrlBtn,\n        );\n        const iframeLibraryTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabIframeLibraryBtn,\n        );\n\n        // Get tab panes\n        const urlPane = form.querySelector(Selectors.IFRAME.elements.paneUrl);\n        const iframeLibraryPane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        // Update tab button states\n        if (urlTabBtn) {\n            urlTabBtn.classList.remove('active');\n            urlTabBtn.setAttribute('aria-selected', 'false');\n        }\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.classList.add('active');\n            iframeLibraryTabBtn.setAttribute('aria-selected', 'true');\n        }\n\n        // Update tab pane visibility\n        if (urlPane) {\n            urlPane.classList.remove('show', 'active');\n        }\n        if (iframeLibraryPane) {\n            iframeLibraryPane.classList.add('show', 'active');\n        }\n    }\n\n    /**\n     * Register event listeners for the iframe library.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    registerIframeLibraryEventListeners(root) {\n        // Listen for messages from the iframe (for video selection)\n        window.addEventListener('message', (event) => {\n            this.handleIframeLibraryMessage(root, event);\n        });\n    }\n\n    /**\n     * Handle iframe library tab click - always refetch content (no caching).\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleIframeLibraryTabClick(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n        const iframeEl = pane\n            ? pane.querySelector(Selectors.IFRAME.elements.iframeLibraryFrame)\n            : null;\n\n        // eslint-disable-next-line no-console\n        console.log(\n            'handleIframeLibraryTabClick called, iframeLibraryLoaded:',\n            this.iframeLibraryLoaded,\n            'iframe src:',\n            iframeEl ? iframeEl.src : 'no iframe',\n            'pane:',\n            pane,\n        );\n\n        // Always refetch content when tab is clicked (no caching)\n        // Reset the loaded state to ensure fresh content is fetched\n        this.iframeLibraryLoaded = false;\n        this.loadIframeLibrary(root);\n    }\n\n    /**\n     * Load the iframe library using LTI flow or fallback to static URL.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    loadIframeLibrary(root) {\n        const ltiConfig = getLti(this.editor);\n\n        // eslint-disable-next-line no-console\n        console.log('loadIframeLibrary called, LTI config:', ltiConfig);\n\n        // Check if LTI is configured with a content item URL\n        if (ltiConfig?.contentItemUrl) {\n            this.loadIframeLibraryViaLti(root, ltiConfig);\n        } else {\n            // Fallback to static URL if LTI not configured\n            this.loadIframeLibraryStatic(root);\n        }\n    }\n\n    /**\n     * Load the iframe library via LTI Deep Linking (Content Item Selection).\n     * Sets the iframe src to contentitem.php which initiates the LTI Deep Linking flow.\n     * This sends an LtiDeepLinkingRequest message, which will redirect to the\n     * tool's content selection interface (e.g., /lti/select-media/).\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {Object} ltiConfig - LTI configuration\n     */\n    loadIframeLibraryViaLti(root, ltiConfig) {\n        // eslint-disable-next-line no-console\n        console.log('loadIframeLibraryViaLti called, config:', ltiConfig);\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            // eslint-disable-next-line no-console\n            console.log('paneIframeLibrary not found!');\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        if (!iframeEl) {\n            // eslint-disable-next-line no-console\n            console.log('iframeEl not found!');\n            return;\n        }\n\n        // Hide placeholder, show loading state\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.remove('d-none');\n        }\n        iframeEl.classList.add('d-none');\n\n        // Set up load listener - note: this may fire multiple times during LTI redirects\n        const loadHandler = () => {\n            // eslint-disable-next-line no-console\n            console.log('LTI iframe loaded');\n            this.handleIframeLibraryLoad(root);\n        };\n        iframeEl.addEventListener('load', loadHandler);\n\n        // Set the iframe src to the content item URL\n        // This initiates the LTI Deep Linking flow:\n        // 1. contentitem.php initiates OIDC login\n        // 2. LTI provider authenticates\n        // 3. Moodle sends LtiDeepLinkingRequest\n        // 4. Tool provider shows content selection interface (e.g., /lti/select-media/)\n        // eslint-disable-next-line no-console\n        console.log(\n            'Setting iframe src to LTI content item URL:',\n            ltiConfig.contentItemUrl,\n        );\n        iframeEl.src = ltiConfig.contentItemUrl;\n    }\n\n    /**\n     * Load the iframe library using static URL (fallback).\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    loadIframeLibraryStatic(root) {\n        // eslint-disable-next-line no-console\n        console.log(\n            'loadIframeLibraryStatic called, URL:',\n            this.iframeLibraryUrl,\n        );\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            // eslint-disable-next-line no-console\n            console.log('paneIframeLibrary not found!');\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        // eslint-disable-next-line no-console\n        console.log('Elements found:', { placeholderEl, loadingEl, iframeEl });\n\n        if (!iframeEl) {\n            // eslint-disable-next-line no-console\n            console.log('iframeEl not found!');\n            return;\n        }\n\n        // Hide placeholder, show loading state\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.remove('d-none');\n        }\n        iframeEl.classList.add('d-none');\n\n        // Set up load listener before setting src\n        const loadHandler = () => {\n            // eslint-disable-next-line no-console\n            console.log('iframe loaded, src:', iframeEl.src);\n            // Only handle if the src matches our target URL\n            if (iframeEl.src === this.iframeLibraryUrl) {\n                this.handleIframeLibraryLoad(root);\n                // Remove the listener after successful load\n                iframeEl.removeEventListener('load', loadHandler);\n            }\n        };\n        iframeEl.addEventListener('load', loadHandler);\n\n        // Set the iframe source\n        iframeEl.src = this.iframeLibraryUrl;\n        // eslint-disable-next-line no-console\n        console.log('iframe src set to:', iframeEl.src);\n    }\n\n    /**\n     * Handle iframe library load event.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleIframeLibraryLoad(root) {\n        // eslint-disable-next-line no-console\n        console.log('handleIframeLibraryLoad called');\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        // Hide placeholder and loading, show iframe\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.add('d-none');\n        }\n        if (iframeEl) {\n            iframeEl.classList.remove('d-none');\n        }\n\n        this.iframeLibraryLoaded = true;\n    }\n\n    /**\n     * Handle messages from the iframe library (for video selection).\n     * Supports both custom videoSelected messages and LTI Deep Linking responses.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {MessageEvent} event - The message event\n     */\n    handleIframeLibraryMessage(root, event) {\n        // eslint-disable-next-line no-console\n        console.log(\n            'handleIframeLibraryMessage received:',\n            event.data,\n            'from origin:',\n            event.origin,\n        );\n\n        const data = event.data;\n\n        if (!data) {\n            return;\n        }\n\n        // Handle custom videoSelected message format (from static iframe or custom MediaCMS implementation)\n        if (data.type === 'videoSelected' && data.embedUrl) {\n            // eslint-disable-next-line no-console\n            console.log(\n                'Video selected (videoSelected):',\n                data.embedUrl,\n                'videoId:',\n                data.videoId,\n            );\n            this.selectIframeLibraryVideo(root, data.embedUrl, data.videoId);\n            return;\n        }\n\n        // Handle LTI Deep Linking response format\n        if (\n            data.type === 'ltiDeepLinkingResponse' ||\n            data.messageType === 'LtiDeepLinkingResponse'\n        ) {\n            // eslint-disable-next-line no-console\n            console.log('LTI Deep Linking response received:', data);\n            const contentItems = data.content_items || data.contentItems || [];\n            if (contentItems.length > 0) {\n                const item = contentItems[0];\n                // Extract embed URL from the content item\n                const embedUrl =\n                    item.url || item.embed_url || item.embedUrl || '';\n                const videoId = item.id || item.mediaId || '';\n                if (embedUrl) {\n                    // eslint-disable-next-line no-console\n                    console.log(\n                        'Video selected (LTI):',\n                        embedUrl,\n                        'videoId:',\n                        videoId,\n                    );\n                    this.selectIframeLibraryVideo(root, embedUrl, videoId);\n                }\n            }\n            return;\n        }\n\n        // Handle MediaCMS specific message format (if different from above)\n        if (data.action === 'selectMedia' || data.action === 'mediaSelected') {\n            const embedUrl = data.embedUrl || data.url || '';\n            const videoId = data.mediaId || data.videoId || data.id || '';\n            if (embedUrl) {\n                // eslint-disable-next-line no-console\n                console.log(\n                    'Video selected (mediaSelected):',\n                    embedUrl,\n                    'videoId:',\n                    videoId,\n                );\n                this.selectIframeLibraryVideo(root, embedUrl, videoId);\n            }\n            return;\n        }\n    }\n\n    /**\n     * Select a video from the iframe library and populate the URL field.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {string} embedUrl - The embed URL for the video\n     * @param {string} videoId - The video ID\n     */\n    selectIframeLibraryVideo(root, embedUrl, videoId) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Populate the URL field\n        const urlInput = form.querySelector(Selectors.IFRAME.elements.url);\n        urlInput.value = embedUrl;\n\n        // Switch to the URL tab using our method\n        this.switchToUrlTab(root);\n\n        // Update the preview\n        this.updatePreview(root);\n\n        // Store the selected video\n        this.selectedLibraryVideo = { embedUrl, videoId };\n    }\n}\n"],"names":["constructor","editor","parseInput","input","trim","iframeMatch","match","this","parseEmbedUrl","startsWith","parseVideoUrl","url","urlObj","URL","baseUrl","protocol","host","pathname","searchParams","has","videoId","get","isEmbed","tParam","showTitle","linkTitle","showRelated","showUserAvatar","startAt","secondsToTimeString","parseInt","rawUrl","isGeneric","e","seconds","mins","Math","floor","secs","toString","padStart","timeStringToSeconds","timeStr","includes","parts","split","isNaN","buildEmbedUrl","parsed","options","set","startAtEnabled","data","editorData","autoConvertOptions","getDefault","key","fallback","_this","isUpdating","undefined","elementid","getElement","id","isupdating","responsive","width","height","is16_9","aspectRatio","is4_3","is1_1","isCustom","selectedIframe","getSelectedIframe","getCurrentIframeData","iframeLibraryLoaded","currentModal","IframeModal","create","title","component","templateContext","getTemplateContext","registerEventListeners","node","selection","getNode","nodeName","toLowerCase","iframe","querySelector","wrapper","closest","src","getAttribute","isResponsive","getFormValues","root","form","Selectors","IFRAME","elements","value","checked","values","embedUrl","aspectRatioCalcs","custom","context","aspectRatioCalc","aspectRatioValue","html","Templates","renderForPromise","updateUrlField","previewContainer","preview","urlWarning","innerHTML","classList","add","remove","previewWidth","min","scale","previewHeight","round","handleInputChange","clearTimeout","debounceTimer","setTimeout","updatePreview","handleAspectRatioChange","dimensions","aspectRatios","modal","getRoot","generateIframeHtml","outerHTML","fire","insertContent","confirmMessage","window","confirm","hide","getBody","$root","addEventListener","forEach","selector","on","ModalEvents","save","handleDialogueSubmission","hidden","destroy","removeBtn","actions","handleRemove","iframeLibraryTabBtn","tabIframeLibraryBtn","preventDefault","stopPropagation","switchToIframeLibraryTab","handleIframeLibraryTabClick","$iframeLibraryTabBtn","jQuery","urlTabBtn","tabUrlBtn","switchToUrlTab","registerIframeLibraryEventListeners","urlPane","paneUrl","iframeLibraryPane","paneIframeLibrary","setAttribute","event","handleIframeLibraryMessage","pane","iframeEl","iframeLibraryFrame","console","log","loadIframeLibrary","ltiConfig","contentItemUrl","loadIframeLibraryViaLti","loadIframeLibraryStatic","placeholderEl","iframeLibraryPlaceholder","loadingEl","iframeLibraryLoading","handleIframeLibraryLoad","iframeLibraryUrl","loadHandler","removeEventListener","origin","type","selectIframeLibraryVideo","messageType","action","mediaId","contentItems","content_items","length","item","embed_url","selectedLibraryVideo"],"mappings":"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"}