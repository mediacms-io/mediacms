{"version":3,"file":"iframeembed.min.js","sources":["../src/iframeembed.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media2 Iframe Embed class.\n *\n * @module      tiny_mediacms/iframeembed\n * @copyright   2024\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport { getString } from 'core/str';\nimport * as ModalEvents from 'core/modal_events';\nimport { component } from './common';\nimport IframeModal from './iframemodal';\nimport Selectors from './selectors';\nimport { getLti } from './options';\n\nexport default class IframeEmbed {\n    editor = null;\n    currentModal = null;\n    isUpdating = false;\n    selectedIframe = null;\n    debounceTimer = null;\n    // Iframe library state\n    iframeLibraryLoaded = false;\n    selectedLibraryVideo = null;\n    iframeLibraryUrl =\n        'https://temp.web357.com/mediacms/deic-mediacms-embed-videos.html';\n\n    constructor(editor) {\n        this.editor = editor;\n    }\n\n    /**\n     * Parse input to extract video URL or iframe src.\n     * Handles: iframe embed code, view URL, or embed URL.\n     *\n     * @param {string} input - The user input (URL or embed code)\n     * @returns {Object|null} Parsed URL info or null if invalid\n     */\n    parseInput(input) {\n        if (!input || !input.trim()) {\n            return null;\n        }\n\n        input = input.trim();\n\n        // Check if it's an iframe embed code\n        const iframeMatch = input.match(\n            /<iframe[^>]*src=[\"']([^\"']+)[\"'][^>]*>/i,\n        );\n        if (iframeMatch) {\n            return this.parseEmbedUrl(iframeMatch[1]);\n        }\n\n        // Check if it's a URL\n        if (input.startsWith('http://') || input.startsWith('https://')) {\n            return this.parseVideoUrl(input);\n        }\n\n        return null;\n    }\n\n    /**\n     * Parse a video view URL and convert to embed format.\n     *\n     * @param {string} url - The video URL\n     * @returns {Object|null} Parsed info\n     */\n    parseVideoUrl(url) {\n        try {\n            const urlObj = new URL(url);\n            const baseUrl = `${urlObj.protocol}//${urlObj.host}`;\n\n            // MediaCMS view URL: /view?m=VIDEO_ID\n            if (urlObj.pathname === '/view' && urlObj.searchParams.has('m')) {\n                return {\n                    baseUrl: baseUrl,\n                    videoId: urlObj.searchParams.get('m'),\n                    isEmbed: false,\n                };\n            }\n\n            // MediaCMS embed URL: /embed?m=VIDEO_ID&options\n            if (urlObj.pathname === '/embed' && urlObj.searchParams.has('m')) {\n                const tParam = urlObj.searchParams.get('t');\n                return {\n                    baseUrl: baseUrl,\n                    videoId: urlObj.searchParams.get('m'),\n                    isEmbed: true,\n                    showTitle: urlObj.searchParams.get('showTitle') === '1',\n                    linkTitle: urlObj.searchParams.get('linkTitle') === '1',\n                    showRelated: urlObj.searchParams.get('showRelated') === '1',\n                    showUserAvatar:\n                        urlObj.searchParams.get('showUserAvatar') === '1',\n                    startAt: tParam\n                        ? this.secondsToTimeString(parseInt(tParam))\n                        : null,\n                };\n            }\n\n            // Generic URL - just use as-is\n            return {\n                baseUrl: baseUrl,\n                rawUrl: url,\n                isGeneric: true,\n            };\n        } catch (e) {\n            return null;\n        }\n    }\n\n    /**\n     * Parse an embed URL.\n     *\n     * @param {string} url - The embed URL\n     * @returns {Object|null} Parsed info\n     */\n    parseEmbedUrl(url) {\n        return this.parseVideoUrl(url);\n    }\n\n    /**\n     * Convert seconds to time string (M:SS format).\n     *\n     * @param {number} seconds - Time in seconds\n     * @returns {string} Time string\n     */\n    secondsToTimeString(seconds) {\n        const mins = Math.floor(seconds / 60);\n        const secs = seconds % 60;\n        return `${mins}:${secs.toString().padStart(2, '0')}`;\n    }\n\n    /**\n     * Convert time string to seconds.\n     *\n     * @param {string} timeStr - Time string (M:SS or just seconds)\n     * @returns {number|null} Seconds or null if invalid\n     */\n    timeStringToSeconds(timeStr) {\n        if (!timeStr || !timeStr.trim()) {\n            return null;\n        }\n        timeStr = timeStr.trim();\n\n        // Handle M:SS format\n        if (timeStr.includes(':')) {\n            const parts = timeStr.split(':');\n            const mins = parseInt(parts[0]) || 0;\n            const secs = parseInt(parts[1]) || 0;\n            return mins * 60 + secs;\n        }\n\n        // Handle plain seconds\n        const secs = parseInt(timeStr);\n        return isNaN(secs) ? null : secs;\n    }\n\n    /**\n     * Build the embed URL with options.\n     *\n     * @param {Object} parsed - Parsed URL info\n     * @param {Object} options - Embed options\n     * @returns {string} The complete embed URL\n     */\n    buildEmbedUrl(parsed, options) {\n        if (parsed.isGeneric) {\n            return parsed.rawUrl;\n        }\n\n        const url = new URL(`${parsed.baseUrl}/embed`);\n        url.searchParams.set('m', parsed.videoId);\n\n        // Always include all options with 1 or 0\n        url.searchParams.set('showTitle', options.showTitle ? '1' : '0');\n        url.searchParams.set('showRelated', options.showRelated ? '1' : '0');\n        url.searchParams.set(\n            'showUserAvatar',\n            options.showUserAvatar ? '1' : '0',\n        );\n        url.searchParams.set('linkTitle', options.linkTitle ? '1' : '0');\n\n        // Add start time if enabled\n        if (options.startAtEnabled && options.startAt) {\n            const seconds = this.timeStringToSeconds(options.startAt);\n            if (seconds !== null && seconds > 0) {\n                url.searchParams.set('t', seconds.toString());\n            }\n        }\n\n        return url.toString();\n    }\n\n    /**\n     * Get the template context for the modal.\n     *\n     * @param {Object} data - Existing data for updating\n     * @returns {Object} Template context\n     */\n    async getTemplateContext(data = {}) {\n        return {\n            elementid: this.editor.getElement().id,\n            isupdating: this.isUpdating,\n            url: data.url || '',\n            showTitle: data.showTitle !== false,\n            linkTitle: data.linkTitle !== false,\n            showRelated: data.showRelated !== false,\n            showUserAvatar: data.showUserAvatar !== false,\n            responsive: data.responsive !== false,\n            startAtEnabled: data.startAtEnabled || false,\n            startAt: data.startAt || '0:00',\n            width: data.width || 560,\n            height: data.height || 315,\n            is16_9: !data.aspectRatio || data.aspectRatio === '16:9',\n            is4_3: data.aspectRatio === '4:3',\n            is1_1: data.aspectRatio === '1:1',\n            isCustom: data.aspectRatio === 'custom',\n        };\n    }\n\n    /**\n     * Display the iframe embed dialog.\n     */\n    async displayDialogue() {\n        this.selectedIframe = this.getSelectedIframe();\n        const data = this.getCurrentIframeData();\n        this.isUpdating = data !== null;\n\n        // Reset iframe library state for new modal\n        this.iframeLibraryLoaded = false;\n\n        this.currentModal = await IframeModal.create({\n            title: getString('iframemodaltitle', component),\n            templateContext: await this.getTemplateContext(data || {}),\n        });\n\n        await this.registerEventListeners(this.currentModal);\n    }\n\n    /**\n     * Get the currently selected iframe in the editor.\n     *\n     * @returns {HTMLElement|null} The iframe element or null\n     */\n    getSelectedIframe() {\n        const node = this.editor.selection.getNode();\n\n        if (node.nodeName.toLowerCase() === 'iframe') {\n            return node;\n        }\n\n        // Check if selection contains an iframe wrapper (including overlay wrapper)\n        const iframe = node.querySelector('iframe');\n        if (iframe) {\n            return iframe;\n        }\n\n        // Check if we're on the overlay or wrapper and need to find the iframe\n        const wrapper =\n            node.closest('.tiny-mediacms-iframe-wrapper') ||\n            node.closest('.tiny-iframe-responsive');\n        if (wrapper) {\n            return wrapper.querySelector('iframe');\n        }\n\n        return null;\n    }\n\n    /**\n     * Get current iframe data for editing.\n     *\n     * @returns {Object|null} Current iframe data or null\n     */\n    getCurrentIframeData() {\n        if (!this.selectedIframe) {\n            return null;\n        }\n\n        const src = this.selectedIframe.getAttribute('src');\n        const parsed = this.parseInput(src);\n\n        // Check if responsive by looking at style\n        const style = this.selectedIframe.getAttribute('style') || '';\n        const isResponsive = style.includes('aspect-ratio');\n\n        return {\n            url: src,\n            width: this.selectedIframe.getAttribute('width') || 560,\n            height: this.selectedIframe.getAttribute('height') || 315,\n            showTitle: parsed?.showTitle ?? true,\n            linkTitle: parsed?.linkTitle ?? true,\n            showRelated: parsed?.showRelated ?? true,\n            showUserAvatar: parsed?.showUserAvatar ?? true,\n            responsive: isResponsive,\n            startAtEnabled: parsed?.startAt !== null,\n            startAt: parsed?.startAt || '0:00',\n        };\n    }\n\n    /**\n     * Get form values from the modal.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @returns {Object} Form values\n     */\n    getFormValues(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        return {\n            url: form.querySelector(Selectors.IFRAME.elements.url).value.trim(),\n            showTitle: form.querySelector(Selectors.IFRAME.elements.showTitle)\n                .checked,\n            linkTitle: form.querySelector(Selectors.IFRAME.elements.linkTitle)\n                .checked,\n            showRelated: form.querySelector(\n                Selectors.IFRAME.elements.showRelated,\n            ).checked,\n            showUserAvatar: form.querySelector(\n                Selectors.IFRAME.elements.showUserAvatar,\n            ).checked,\n            responsive: form.querySelector(Selectors.IFRAME.elements.responsive)\n                .checked,\n            startAtEnabled: form.querySelector(\n                Selectors.IFRAME.elements.startAtEnabled,\n            ).checked,\n            startAt: form\n                .querySelector(Selectors.IFRAME.elements.startAt)\n                .value.trim(),\n            aspectRatio: form.querySelector(\n                Selectors.IFRAME.elements.aspectRatio,\n            ).value,\n            width:\n                parseInt(\n                    form.querySelector(Selectors.IFRAME.elements.width).value,\n                ) || 560,\n            height:\n                parseInt(\n                    form.querySelector(Selectors.IFRAME.elements.height).value,\n                ) || 315,\n        };\n    }\n\n    /**\n     * Generate the iframe HTML.\n     *\n     * @param {Object} values - Form values\n     * @returns {Promise<string>} Generated HTML\n     */\n    async generateIframeHtml(values) {\n        const parsed = this.parseInput(values.url);\n        if (!parsed) {\n            return '';\n        }\n\n        const embedUrl = this.buildEmbedUrl(parsed, values);\n\n        // Calculate aspect ratio values for CSS\n        const aspectRatioCalcs = {\n            '16:9': '16 / 9',\n            '4:3': '4 / 3',\n            '1:1': '1 / 1',\n            custom: `${values.width} / ${values.height}`,\n        };\n\n        const context = {\n            src: embedUrl,\n            width: values.width,\n            height: values.height,\n            responsive: values.responsive,\n            aspectRatioCalc: aspectRatioCalcs[values.aspectRatio] || '16 / 9',\n            aspectRatioValue: aspectRatioCalcs[values.aspectRatio] || '16 / 9',\n        };\n\n        const { html } = await Templates.renderForPromise(\n            'tiny_mediacms/iframe_embed_output',\n            context,\n        );\n        return html;\n    }\n\n    /**\n     * Update the preview in the modal.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    async updatePreview(root) {\n        const values = this.getFormValues(root);\n        const previewContainer = root.querySelector(\n            Selectors.IFRAME.elements.preview,\n        );\n        const urlWarning = root.querySelector(\n            Selectors.IFRAME.elements.urlWarning,\n        );\n\n        if (!values.url) {\n            previewContainer.innerHTML =\n                '<span class=\"text-muted\">Enter a video URL to see preview</span>';\n            urlWarning.classList.add('d-none');\n            return;\n        }\n\n        const parsed = this.parseInput(values.url);\n        if (!parsed) {\n            previewContainer.innerHTML =\n                '<span class=\"text-danger\">Invalid URL format</span>';\n            urlWarning.classList.remove('d-none');\n            return;\n        }\n\n        urlWarning.classList.add('d-none');\n        const embedUrl = this.buildEmbedUrl(parsed, values);\n\n        // Show a scaled preview\n        const previewWidth = Math.min(values.width, 400);\n        const scale = previewWidth / values.width;\n        const previewHeight = Math.round(values.height * scale);\n\n        previewContainer.innerHTML = `\n            <iframe \n                src=\"${embedUrl}\" \n                width=\"${previewWidth}\" \n                height=\"${previewHeight}\" \n                frameborder=\"0\" \n                allowfullscreen\n                style=\"max-width: 100%;\">\n            </iframe>\n        `;\n    }\n\n    /**\n     * Handle form input changes with debounce.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleInputChange(root) {\n        clearTimeout(this.debounceTimer);\n        this.debounceTimer = setTimeout(() => {\n            this.updatePreview(root);\n        }, 500);\n    }\n\n    /**\n     * Handle aspect ratio change - update dimensions.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleAspectRatioChange(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const aspectRatio = form.querySelector(\n            Selectors.IFRAME.elements.aspectRatio,\n        ).value;\n        const dimensions = Selectors.IFRAME.aspectRatios[aspectRatio];\n\n        // Only update dimensions for predefined ratios, not 'custom'\n        if (dimensions && aspectRatio !== 'custom') {\n            form.querySelector(Selectors.IFRAME.elements.width).value =\n                dimensions.width;\n            form.querySelector(Selectors.IFRAME.elements.height).value =\n                dimensions.height;\n        }\n\n        this.updatePreview(root);\n    }\n\n    /**\n     * Handle dialog submission.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async handleDialogueSubmission(modal) {\n        const root = modal.getRoot()[0];\n        const values = this.getFormValues(root);\n\n        if (!values.url) {\n            return;\n        }\n\n        const html = await this.generateIframeHtml(values);\n        if (html) {\n            if (this.isUpdating && this.selectedIframe) {\n                // Replace existing iframe (including wrapper if present)\n                // Check for both old wrapper and new overlay wrapper\n                const wrapper =\n                    this.selectedIframe.closest(\n                        '.tiny-mediacms-iframe-wrapper',\n                    ) || this.selectedIframe.closest('.tiny-iframe-responsive');\n                if (wrapper) {\n                    wrapper.outerHTML = html;\n                } else {\n                    this.selectedIframe.outerHTML = html;\n                }\n                this.isUpdating = false;\n                // Fire change event to trigger overlay reprocessing\n                this.editor.fire('Change');\n            } else {\n                this.editor.insertContent(html);\n            }\n        }\n    }\n\n    /**\n     * Handle video removal from the editor.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async handleRemove(modal) {\n        // Get confirmation string\n        const confirmMessage = await getString(\n            'removeiframeconfirm',\n            component,\n        );\n\n        // Show confirmation dialog\n        // eslint-disable-next-line no-alert\n        if (!window.confirm(confirmMessage)) {\n            return;\n        }\n\n        if (this.selectedIframe) {\n            // Remove the iframe (including wrapper if present)\n            const wrapper =\n                this.selectedIframe.closest('.tiny-mediacms-iframe-wrapper') ||\n                this.selectedIframe.closest('.tiny-iframe-responsive');\n            if (wrapper) {\n                wrapper.remove();\n            } else {\n                this.selectedIframe.remove();\n            }\n        }\n\n        // Close the modal\n        this.isUpdating = false;\n        modal.hide();\n    }\n\n    /**\n     * Register event listeners for the modal.\n     *\n     * @param {Object} modal - The modal instance\n     */\n    async registerEventListeners(modal) {\n        await modal.getBody();\n        const $root = modal.getRoot();\n        const root = $root[0];\n\n        // Input change handlers\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // URL input\n        form.querySelector(Selectors.IFRAME.elements.url).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n\n        // Checkbox options\n        [\n            Selectors.IFRAME.elements.showTitle,\n            Selectors.IFRAME.elements.linkTitle,\n            Selectors.IFRAME.elements.showRelated,\n            Selectors.IFRAME.elements.showUserAvatar,\n            Selectors.IFRAME.elements.responsive,\n            Selectors.IFRAME.elements.startAtEnabled,\n        ].forEach((selector) => {\n            form.querySelector(selector).addEventListener('change', () =>\n                this.handleInputChange(root),\n            );\n        });\n\n        // Start at time input\n        form.querySelector(Selectors.IFRAME.elements.startAt).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n\n        // Aspect ratio change\n        form.querySelector(\n            Selectors.IFRAME.elements.aspectRatio,\n        ).addEventListener('change', () => this.handleAspectRatioChange(root));\n\n        // Dimension inputs\n        form.querySelector(Selectors.IFRAME.elements.width).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n        form.querySelector(Selectors.IFRAME.elements.height).addEventListener(\n            'input',\n            () => this.handleInputChange(root),\n        );\n\n        // Modal events\n        $root.on(ModalEvents.save, () => this.handleDialogueSubmission(modal));\n        $root.on(ModalEvents.hidden, () => {\n            this.currentModal.destroy();\n        });\n\n        // Remove button handler (only present when updating)\n        const removeBtn = root.querySelector(Selectors.IFRAME.actions.remove);\n        if (removeBtn) {\n            removeBtn.addEventListener('click', () => this.handleRemove(modal));\n        }\n\n        // Initial preview if we have a URL\n        const urlInput = form.querySelector(Selectors.IFRAME.elements.url);\n        if (urlInput.value) {\n            this.updatePreview(root);\n        }\n\n        // Tab change handler - load iframe library when switching to iframe library tab\n        const iframeLibraryTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabIframeLibraryBtn,\n        );\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n\n                // Manually handle tab switching for Bootstrap 5\n                this.switchToIframeLibraryTab(root);\n\n                // Small delay to ensure tab pane is visible before loading iframe\n                setTimeout(() => this.handleIframeLibraryTabClick(root), 100);\n            });\n            // Also handle Bootstrap tab events (if Bootstrap handles it)\n            iframeLibraryTabBtn.addEventListener('shown.bs.tab', () =>\n                this.handleIframeLibraryTabClick(root),\n            );\n            // jQuery Bootstrap 4 event\n            const $iframeLibraryTabBtn = window.jQuery\n                ? window.jQuery(iframeLibraryTabBtn)\n                : null;\n            if ($iframeLibraryTabBtn) {\n                $iframeLibraryTabBtn.on('shown.bs.tab', () =>\n                    this.handleIframeLibraryTabClick(root),\n                );\n            }\n        }\n\n        // Tab change handler for URL tab\n        const urlTabBtn = form.querySelector(\n            Selectors.IFRAME.elements.tabUrlBtn,\n        );\n        if (urlTabBtn) {\n            urlTabBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n\n                // Manually handle tab switching\n                this.switchToUrlTab(root);\n            });\n        }\n\n        // Iframe library event listeners\n        this.registerIframeLibraryEventListeners(root);\n    }\n\n    /**\n     * Switch to the URL tab.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    switchToUrlTab(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Get tab buttons\n        const urlTabBtn = form.querySelector(Selectors.IFRAME.elements.tabUrlBtn);\n        const iframeLibraryTabBtn = form.querySelector(Selectors.IFRAME.elements.tabIframeLibraryBtn);\n\n        // Get tab panes\n        const urlPane = form.querySelector(Selectors.IFRAME.elements.paneUrl);\n        const iframeLibraryPane = form.querySelector(Selectors.IFRAME.elements.paneIframeLibrary);\n\n        // Update tab button states\n        if (urlTabBtn) {\n            urlTabBtn.classList.add('active');\n            urlTabBtn.setAttribute('aria-selected', 'true');\n        }\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.classList.remove('active');\n            iframeLibraryTabBtn.setAttribute('aria-selected', 'false');\n        }\n\n        // Update tab pane visibility\n        if (urlPane) {\n            urlPane.classList.add('show', 'active');\n        }\n        if (iframeLibraryPane) {\n            iframeLibraryPane.classList.remove('show', 'active');\n        }\n    }\n\n    /**\n     * Switch to the iframe library tab.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    switchToIframeLibraryTab(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Get tab buttons\n        const urlTabBtn = form.querySelector(Selectors.IFRAME.elements.tabUrlBtn);\n        const iframeLibraryTabBtn = form.querySelector(Selectors.IFRAME.elements.tabIframeLibraryBtn);\n\n        // Get tab panes\n        const urlPane = form.querySelector(Selectors.IFRAME.elements.paneUrl);\n        const iframeLibraryPane = form.querySelector(Selectors.IFRAME.elements.paneIframeLibrary);\n\n        // Update tab button states\n        if (urlTabBtn) {\n            urlTabBtn.classList.remove('active');\n            urlTabBtn.setAttribute('aria-selected', 'false');\n        }\n        if (iframeLibraryTabBtn) {\n            iframeLibraryTabBtn.classList.add('active');\n            iframeLibraryTabBtn.setAttribute('aria-selected', 'true');\n        }\n\n        // Update tab pane visibility\n        if (urlPane) {\n            urlPane.classList.remove('show', 'active');\n        }\n        if (iframeLibraryPane) {\n            iframeLibraryPane.classList.add('show', 'active');\n        }\n    }\n\n    /**\n     * Register event listeners for the iframe library.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    registerIframeLibraryEventListeners(root) {\n        // Listen for messages from the iframe (for video selection)\n        window.addEventListener('message', (event) => {\n            this.handleIframeLibraryMessage(root, event);\n        });\n    }\n\n    /**\n     * Handle iframe library tab click - load iframe if not already loaded.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleIframeLibraryTabClick(root) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n        const iframeEl = pane\n            ? pane.querySelector(Selectors.IFRAME.elements.iframeLibraryFrame)\n            : null;\n\n        // eslint-disable-next-line no-console\n        console.log(\n            'handleIframeLibraryTabClick called, iframeLibraryLoaded:',\n            this.iframeLibraryLoaded,\n            'iframe src:',\n            iframeEl ? iframeEl.src : 'no iframe',\n            'pane:',\n            pane,\n        );\n\n        // Load if not loaded or iframe has no source or empty source\n        if (\n            !this.iframeLibraryLoaded ||\n            (iframeEl && (!iframeEl.src || iframeEl.src === ''))\n        ) {\n            this.loadIframeLibrary(root);\n        }\n    }\n\n    /**\n     * Load the iframe library using LTI flow or fallback to static URL.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    loadIframeLibrary(root) {\n        const ltiConfig = getLti(this.editor);\n\n        // eslint-disable-next-line no-console\n        console.log('loadIframeLibrary called, LTI config:', ltiConfig);\n\n        // Check if LTI is configured with a content item URL\n        if (ltiConfig?.contentItemUrl) {\n            this.loadIframeLibraryViaLti(root, ltiConfig);\n        } else {\n            // Fallback to static URL if LTI not configured\n            this.loadIframeLibraryStatic(root);\n        }\n    }\n\n    /**\n     * Load the iframe library via LTI Deep Linking (Content Item Selection).\n     * Sets the iframe src to contentitem.php which initiates the LTI Deep Linking flow.\n     * This sends an LtiDeepLinkingRequest message, which will redirect to the\n     * tool's content selection interface (e.g., /lti/select-media/).\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {Object} ltiConfig - LTI configuration\n     */\n    loadIframeLibraryViaLti(root, ltiConfig) {\n        // eslint-disable-next-line no-console\n        console.log('loadIframeLibraryViaLti called, config:', ltiConfig);\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            // eslint-disable-next-line no-console\n            console.log('paneIframeLibrary not found!');\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        if (!iframeEl) {\n            // eslint-disable-next-line no-console\n            console.log('iframeEl not found!');\n            return;\n        }\n\n        // Hide placeholder, show loading state\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.remove('d-none');\n        }\n        iframeEl.classList.add('d-none');\n\n        // Set up load listener - note: this may fire multiple times during LTI redirects\n        const loadHandler = () => {\n            // eslint-disable-next-line no-console\n            console.log('LTI iframe loaded');\n            this.handleIframeLibraryLoad(root);\n        };\n        iframeEl.addEventListener('load', loadHandler);\n\n        // Set the iframe src to the content item URL\n        // This initiates the LTI Deep Linking flow:\n        // 1. contentitem.php initiates OIDC login\n        // 2. LTI provider authenticates\n        // 3. Moodle sends LtiDeepLinkingRequest\n        // 4. Tool provider shows content selection interface (e.g., /lti/select-media/)\n        // eslint-disable-next-line no-console\n        console.log('Setting iframe src to LTI content item URL:', ltiConfig.contentItemUrl);\n        iframeEl.src = ltiConfig.contentItemUrl;\n    }\n\n    /**\n     * Load the iframe library using static URL (fallback).\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    loadIframeLibraryStatic(root) {\n        // eslint-disable-next-line no-console\n        console.log(\n            'loadIframeLibraryStatic called, URL:',\n            this.iframeLibraryUrl,\n        );\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            // eslint-disable-next-line no-console\n            console.log('paneIframeLibrary not found!');\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        // eslint-disable-next-line no-console\n        console.log('Elements found:', { placeholderEl, loadingEl, iframeEl });\n\n        if (!iframeEl) {\n            // eslint-disable-next-line no-console\n            console.log('iframeEl not found!');\n            return;\n        }\n\n        // Hide placeholder, show loading state\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.remove('d-none');\n        }\n        iframeEl.classList.add('d-none');\n\n        // Set up load listener before setting src\n        const loadHandler = () => {\n            // eslint-disable-next-line no-console\n            console.log('iframe loaded, src:', iframeEl.src);\n            // Only handle if the src matches our target URL\n            if (iframeEl.src === this.iframeLibraryUrl) {\n                this.handleIframeLibraryLoad(root);\n                // Remove the listener after successful load\n                iframeEl.removeEventListener('load', loadHandler);\n            }\n        };\n        iframeEl.addEventListener('load', loadHandler);\n\n        // Set the iframe source\n        iframeEl.src = this.iframeLibraryUrl;\n        // eslint-disable-next-line no-console\n        console.log('iframe src set to:', iframeEl.src);\n    }\n\n    /**\n     * Handle iframe library load event.\n     *\n     * @param {HTMLElement} root - Modal root element\n     */\n    handleIframeLibraryLoad(root) {\n        // eslint-disable-next-line no-console\n        console.log('handleIframeLibraryLoad called');\n\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n        const pane = form.querySelector(\n            Selectors.IFRAME.elements.paneIframeLibrary,\n        );\n\n        if (!pane) {\n            return;\n        }\n\n        const placeholderEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryPlaceholder,\n        );\n        const loadingEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryLoading,\n        );\n        const iframeEl = pane.querySelector(\n            Selectors.IFRAME.elements.iframeLibraryFrame,\n        );\n\n        // Hide placeholder and loading, show iframe\n        if (placeholderEl) {\n            placeholderEl.classList.add('d-none');\n        }\n        if (loadingEl) {\n            loadingEl.classList.add('d-none');\n        }\n        if (iframeEl) {\n            iframeEl.classList.remove('d-none');\n        }\n\n        this.iframeLibraryLoaded = true;\n    }\n\n    /**\n     * Handle messages from the iframe library (for video selection).\n     * Supports both custom videoSelected messages and LTI Deep Linking responses.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {MessageEvent} event - The message event\n     */\n    handleIframeLibraryMessage(root, event) {\n        // eslint-disable-next-line no-console\n        console.log(\n            'handleIframeLibraryMessage received:',\n            event.data,\n            'from origin:',\n            event.origin,\n        );\n\n        const data = event.data;\n\n        if (!data) {\n            return;\n        }\n\n        // Handle custom videoSelected message format (from static iframe or custom MediaCMS implementation)\n        if (data.type === 'videoSelected' && data.embedUrl) {\n            // eslint-disable-next-line no-console\n            console.log(\n                'Video selected (videoSelected):',\n                data.embedUrl,\n                'videoId:',\n                data.videoId,\n            );\n            this.selectIframeLibraryVideo(root, data.embedUrl, data.videoId);\n            return;\n        }\n\n        // Handle LTI Deep Linking response format\n        if (\n            data.type === 'ltiDeepLinkingResponse' ||\n            data.messageType === 'LtiDeepLinkingResponse'\n        ) {\n            // eslint-disable-next-line no-console\n            console.log('LTI Deep Linking response received:', data);\n            const contentItems = data.content_items || data.contentItems || [];\n            if (contentItems.length > 0) {\n                const item = contentItems[0];\n                // Extract embed URL from the content item\n                const embedUrl =\n                    item.url || item.embed_url || item.embedUrl || '';\n                const videoId = item.id || item.mediaId || '';\n                if (embedUrl) {\n                    // eslint-disable-next-line no-console\n                    console.log(\n                        'Video selected (LTI):',\n                        embedUrl,\n                        'videoId:',\n                        videoId,\n                    );\n                    this.selectIframeLibraryVideo(root, embedUrl, videoId);\n                }\n            }\n            return;\n        }\n\n        // Handle MediaCMS specific message format (if different from above)\n        if (data.action === 'selectMedia' || data.action === 'mediaSelected') {\n            const embedUrl = data.embedUrl || data.url || '';\n            const videoId = data.mediaId || data.videoId || data.id || '';\n            if (embedUrl) {\n                // eslint-disable-next-line no-console\n                console.log(\n                    'Video selected (mediaSelected):',\n                    embedUrl,\n                    'videoId:',\n                    videoId,\n                );\n                this.selectIframeLibraryVideo(root, embedUrl, videoId);\n            }\n            return;\n        }\n    }\n\n    /**\n     * Select a video from the iframe library and populate the URL field.\n     *\n     * @param {HTMLElement} root - Modal root element\n     * @param {string} embedUrl - The embed URL for the video\n     * @param {string} videoId - The video ID\n     */\n    selectIframeLibraryVideo(root, embedUrl, videoId) {\n        const form = root.querySelector(Selectors.IFRAME.elements.form);\n\n        // Populate the URL field\n        const urlInput = form.querySelector(Selectors.IFRAME.elements.url);\n        urlInput.value = embedUrl;\n\n        // Switch to the URL tab using our method\n        this.switchToUrlTab(root);\n\n        // Update the preview\n        this.updatePreview(root);\n\n        // Store the selected video\n        this.selectedLibraryVideo = { embedUrl, videoId };\n    }\n}\n"],"names":["constructor","editor","parseInput","input","trim","iframeMatch","match","this","parseEmbedUrl","startsWith","parseVideoUrl","url","urlObj","URL","baseUrl","protocol","host","pathname","searchParams","has","videoId","get","isEmbed","tParam","showTitle","linkTitle","showRelated","showUserAvatar","startAt","secondsToTimeString","parseInt","rawUrl","isGeneric","e","seconds","mins","Math","floor","secs","toString","padStart","timeStringToSeconds","timeStr","includes","parts","split","isNaN","buildEmbedUrl","parsed","options","set","startAtEnabled","data","elementid","getElement","id","isupdating","isUpdating","responsive","width","height","is16_9","aspectRatio","is4_3","is1_1","isCustom","selectedIframe","getSelectedIframe","getCurrentIframeData","iframeLibraryLoaded","currentModal","IframeModal","create","title","component","templateContext","getTemplateContext","registerEventListeners","node","selection","getNode","nodeName","toLowerCase","iframe","querySelector","wrapper","closest","src","getAttribute","isResponsive","getFormValues","root","form","Selectors","IFRAME","elements","value","checked","values","embedUrl","aspectRatioCalcs","custom","context","aspectRatioCalc","aspectRatioValue","html","Templates","renderForPromise","previewContainer","preview","urlWarning","innerHTML","classList","add","remove","previewWidth","min","scale","previewHeight","round","handleInputChange","clearTimeout","debounceTimer","setTimeout","updatePreview","handleAspectRatioChange","dimensions","aspectRatios","modal","getRoot","generateIframeHtml","outerHTML","fire","insertContent","confirmMessage","window","confirm","hide","getBody","$root","addEventListener","forEach","selector","on","ModalEvents","save","handleDialogueSubmission","hidden","destroy","removeBtn","actions","handleRemove","iframeLibraryTabBtn","tabIframeLibraryBtn","preventDefault","stopPropagation","switchToIframeLibraryTab","handleIframeLibraryTabClick","$iframeLibraryTabBtn","jQuery","urlTabBtn","tabUrlBtn","switchToUrlTab","registerIframeLibraryEventListeners","urlPane","paneUrl","iframeLibraryPane","paneIframeLibrary","setAttribute","event","handleIframeLibraryMessage","pane","iframeEl","iframeLibraryFrame","console","log","loadIframeLibrary","ltiConfig","contentItemUrl","loadIframeLibraryViaLti","loadIframeLibraryStatic","placeholderEl","iframeLibraryPlaceholder","loadingEl","iframeLibraryLoading","handleIframeLibraryLoad","iframeLibraryUrl","loadHandler","removeEventListener","origin","type","selectIframeLibraryVideo","messageType","action","mediaId","contentItems","content_items","length","item","embed_url","selectedLibraryVideo"],"mappings":"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"}